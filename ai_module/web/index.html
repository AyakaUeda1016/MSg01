<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>P_voice_ai ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      text-align: center;
      background-color: #f5f5f5;
      padding-top: 40px;
    }
    h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }
    button {
      font-size: 18px;
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      margin: 10px;
      cursor: pointer;
    }
    #startBtn { background-color: #4285f4; color: white; }
    #stopBtn { background-color: #888; color: white; }
    #resetBtn { background-color: #4285f4; color: white; }
    #log {
      margin-top: 20px;
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      width: 60%;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      text-align: left;
    }
  </style>
</head>
<body>
  <h1>ğŸ™ï¸ P_voice_ai ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ</h1>
  <p>ã€ŒéŒ²éŸ³é–‹å§‹ã€â†’è©±ã™â†’ã€ŒéŒ²éŸ³åœæ­¢ã€ã§éŸ³å£°ã‚’Flaskã‚µãƒ¼ãƒã«é€ä¿¡ã—ã¾ã™ã€‚</p>
  <button id="startBtn">ğŸ™ï¸ éŒ²éŸ³é–‹å§‹</button>
  <button id="stopBtn" disabled>â¹ éŒ²éŸ³åœæ­¢</button>
  <button id="resetBtn">â™»ï¸ ä¼šè©±ãƒªã‚»ãƒƒãƒˆ</button>

  <div id="log">å¾…æ©Ÿä¸­...</div>

  <script>
    let mediaRecorder;
    let audioChunks = [];

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const resetBtn = document.getElementById("resetBtn");
    const logDiv = document.getElementById("log");

    // --- éŒ²éŸ³é–‹å§‹ ---
    startBtn.onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
        audioChunks = [];

        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) {
            audioChunks.push(e.data);
          }
        };

        mediaRecorder.onstop = async () => {
          const blob = new Blob(audioChunks, { type: "audio/webm" });

          // âœ… formDataã‚’ã“ã“ã§ä½œã‚‹
          const formData = new FormData();
          formData.append("file", blob, "recorded.webm");

          logDiv.innerHTML = "ğŸ¬ éŒ²éŸ³åœæ­¢ã€é€ä¿¡ä¸­...";

          try {
            const res = await fetch("http://127.0.0.1:5000/api/conversation", {
              method: "POST",
              body: formData,
            });

            if (!res.ok) {
              throw new Error(`HTTP ${res.status}`);
            }

            const data = await res.json();
            logDiv.innerHTML = `
              <b>ğŸ—£ Whisperæ–‡å­—èµ·ã“ã—:</b> ${data.transcript}<br>
              <b>ğŸ’¬ AIã®è¿”ç­”:</b> ${data.reply}<br>
              <b>âš™ï¸ æ„Ÿæƒ…ã‚¹ã‚³ã‚¢:</b> Arousal=${data.emotion.arousal}, Valence=${data.emotion.valence}
            `;
          } catch (err) {
            logDiv.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}`;
          }
        };

        mediaRecorder.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;
        logDiv.innerHTML = "ğŸ™ï¸ éŒ²éŸ³ä¸­... è©±ã—ã‹ã‘ã¦ãã ã•ã„ã€‚";

      } catch (err) {
        logDiv.innerHTML = `ğŸ§ ãƒã‚¤ã‚¯ã‚¨ãƒ©ãƒ¼: ${err.message}`;
      }
    };

    // --- éŒ²éŸ³åœæ­¢ ---
    stopBtn.onclick = () => {
      mediaRecorder.stop();
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };

    // --- ä¼šè©±ãƒªã‚»ãƒƒãƒˆ ---
    resetBtn.onclick = async () => {
      try {
        const res = await fetch("http://127.0.0.1:5000/api/reset", { method: "POST" });
        const data = await res.json();
        logDiv.innerHTML = data.message;
      } catch (err) {
        logDiv.innerHTML = `âš ï¸ ãƒªã‚»ãƒƒãƒˆå¤±æ•—: ${err.message}`;
      }
    };
  </script>
</body>
</html>
