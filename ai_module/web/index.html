<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>P_voice_ai ã‚·ãƒŠãƒªã‚ªåˆ‡ã‚Šæ›¿ãˆ & ãƒ†ã‚¹ãƒˆç”»é¢</title>

  <link rel="stylesheet" href="css/loading.css">

  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    h1 { font-size: 22px; margin-bottom: 10px; }
    .card {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 16px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    button {
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
    }
    #recBtn { background: #ff5252; color: #fff; }
    #previewOK { background: #4caf50; color: #fff; }
    #previewNG { background: #ff9800; color: #fff; }

    #log {
      white-space: pre-wrap;
      background: #222;
      color: #0f0;
      padding: 12px;
      border-radius: 8px;
      height: 200px;
      overflow-y: auto;
      font-size: 13px;
    }

    #textResult .label { font-weight: bold; color: #333; }
    #textResult .user { color: #1565c0; }
    #textResult .ai { color: #2e7d32; }

    #previewArea {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 12px;
      border-radius: 8px;
      margin-top: 8px;
      display: none;
    }
  </style>
</head>

<body>

<!-- ================================
     â˜… ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
================================ -->
<div id="voicevoxOverlay">
  <div>
    <div class="loading-icon"></div>
    <div class="loading-text">NowLoading...</div>
  </div>
</div>

<h1>P_voice_ai ã‚·ãƒŠãƒªã‚ªåˆ‡ã‚Šæ›¿ãˆ & ä¼šè©±ãƒ†ã‚¹ãƒˆ</h1>

<!-- â–  ã‚·ãƒŠãƒªã‚ªæƒ…å ± -->
<div class="card">
  <h2>ğŸ“˜ ç¾åœ¨ã®ã‚·ãƒŠãƒªã‚ª</h2>
  <p><strong>ã‚¿ã‚¤ãƒˆãƒ«:</strong> <span id="sc_title">å–å¾—ä¸­...</span></p>
  <p><strong>ã‚·ãƒ¼ãƒ³èª¬æ˜:</strong> <span id="sc_scene">å–å¾—ä¸­...</span></p>
  <p><strong>é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong> <span id="sc_start">å–å¾—ä¸­...</span></p>
</div>

<!-- â–  ã‚·ãƒŠãƒªã‚ªåˆ‡æ›¿ -->
<div class="card">
  <h2>ğŸ”„ ã‚·ãƒŠãƒªã‚ªåˆ‡ã‚Šæ›¿ãˆ</h2>

  <label>ã‚·ãƒŠãƒªã‚ªIDã‚’é¸æŠ:
    <select id="scenarioSelect">
      <option value="1">1: æœç¤¼å¾Œã®å‹é”ã¨ã®ä¼šè©±</option>
      <option value="2">2: å°±æ´»ã®é¢æ¥ã‚·ãƒŠãƒªã‚ª</option>
      <option value="3">3: éƒ¨æ´»å¾Œã®å¸°ã‚Šé“ã‚·ãƒŠãƒªã‚ª</option>
    </select>
  </label>

  <br><br>
  <button id="switchBtn">âš™ ã‚·ãƒŠãƒªã‚ªå¤‰æ›´</button>
  <p id="switchStatus"></p>
</div>

<!-- â–  éŒ²éŸ³ & ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
<div class="card">
  <h2>ğŸ¤ éŒ²éŸ³ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
  <button id="recBtn">â— éŒ²éŸ³é–‹å§‹</button>

  <p>çŠ¶æ…‹: <span id="status">åœæ­¢ä¸­</span></p>

  <div id="previewArea">
    <p><strong>ğŸ“ Whisperæ–‡å­—èµ·ã“ã—çµæœï¼ˆé€ä¿¡å‰ç¢ºèªï¼‰</strong></p>
    <p id="previewText"></p>

    <button id="previewOK">OKï¼ˆã“ã®å†…å®¹ã§é€ä¿¡ï¼‰</button>
    <button id="previewNG">éŒ²éŸ³ã—ãªãŠã™</button>
  </div>
</div>

<!-- â–  ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º -->
<div class="card">
  <h2>ğŸ—£ ä¼šè©±ãƒ†ã‚­ã‚¹ãƒˆ</h2>
  <div id="textResult">ã“ã“ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè©±ã¨AIå¿œç­”ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
</div>

<!-- â–  VoiceVox éŸ³å£° -->
<div class="card">
  <h2>ğŸ”Š VoiceVox éŸ³å£°</h2>
  <div id="audioArea">ã“ã“ã«éŸ³å£°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
</div>

<!-- â–  JSONãƒ­ã‚° -->
<div class="card">
  <h2>ğŸ“© ã‚µãƒ¼ãƒå¿œç­” JSON</h2>
  <div id="log">ã“ã“ã«å¿œç­”ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
</div>

<script>
// ---------------------------------------------------
// API URL
// ---------------------------------------------------
const API_BASE = "http://127.0.0.1:5000";

// Overaly ON/OFF
function showLoading() {
  document.getElementById("voicevoxOverlay").style.display = "flex";
}
function hideLoading() {
  document.getElementById("voicevoxOverlay").style.display = "none";
}

// ---------------------------------------------------
// ã‚·ãƒŠãƒªã‚ªæƒ…å ±
// ---------------------------------------------------
async function loadScenario() {
  const res = await fetch(`${API_BASE}/api/current_scenario`);
  const json = await res.json();

  document.getElementById("sc_title").innerText = json.character_role + " ã®ã‚·ãƒŠãƒªã‚ª";
  document.getElementById("sc_scene").innerText = json.scene;
  document.getElementById("sc_start").innerText = json.start_message;
}
loadScenario();

// ---------------------------------------------------
// ã‚·ãƒŠãƒªã‚ªåˆ‡æ›¿
// ---------------------------------------------------
document.getElementById("switchBtn").onclick = async () => {
  const id = document.getElementById("scenarioSelect").value;

  const res = await fetch(`${API_BASE}/api/set_scenario`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id: Number(id) })
  });

  const json = await res.json();
  document.getElementById("switchStatus").innerText = json.message;

  loadScenario();
};

// ---------------------------------------------------
// éŒ²éŸ³å‡¦ç†
// ---------------------------------------------------
let mediaRecorder;
let audioChunks = [];
let audioBlob = null;

document.getElementById("recBtn").onclick = async () => {
  if (!mediaRecorder || mediaRecorder.state === "inactive") {

    audioChunks = [];
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });

    mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);

    mediaRecorder.onstop = async () => {
      audioBlob = new Blob(audioChunks, { type: "audio/webm" });

      document.getElementById("status").innerText =
        "éŒ²éŸ³å®Œäº† â†’ Whisperã§è§£æä¸­â€¦";

      // ãƒ­ãƒ¼ãƒ‰ONï¼ˆWhisperè§£æå‰ï¼‰
      showLoading();

      await previewTranscription();
    };

    mediaRecorder.start();
    document.getElementById("status").innerText = "éŒ²éŸ³ä¸­â€¦";
    document.getElementById("recBtn").innerText = "â–  éŒ²éŸ³åœæ­¢";

  } else {
    mediaRecorder.stop();
    document.getElementById("recBtn").innerText = "â— éŒ²éŸ³é–‹å§‹";
  }
};

// ---------------------------------------------------
// Whisper ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è§£æ
// ---------------------------------------------------
async function previewTranscription() {
  const formData = new FormData();
  formData.append("file", audioBlob, "audio.webm");

  const res = await fetch(`${API_BASE}/api/transcribe_preview`, {
    method: "POST",
    body: formData
  });
  const json = await res.json();

  document.getElementById("previewText").innerText =
    json.transcript || "ï¼ˆç©ºã§ã™ï¼‰";
  document.getElementById("previewArea").style.display = "block";
  document.getElementById("status").innerText = "ç¢ºèªã—ã¦ãã ã•ã„ â†“";

  // Whisperè§£æãŒçµ‚ã‚ã£ãŸã‚‰ãƒ­ãƒ¼ãƒ‰OFF
  hideLoading();
}

// ---------------------------------------------------
// OK â†’ æœ¬ç•ªé€ä¿¡
// ---------------------------------------------------
document.getElementById("previewOK").onclick = async () => {

  showLoading(); // æœ¬ç•ªå‡¦ç†å…¨ä½“

  const formData = new FormData();
  formData.append("file", audioBlob, "audio.webm");

  const res = await fetch(`${API_BASE}/api/conversation`, {
    method: "POST",
    body: formData
  });
  const json = await res.json();

  document.getElementById("log").innerText =
    JSON.stringify(json, null, 2);

  document.getElementById("textResult").innerHTML = `
    <div><span class="label">ğŸ§‘ ã‚ãªãŸ:</span>
    <span class="user">${json.transcript}</span></div>
    <div><span class="label">ğŸ¤– AI:</span>
    <span class="ai">${json.reply}</span></div>
  `;

  const audioArea = document.getElementById("audioArea");
  audioArea.innerHTML = "";

  if (json.voice_audio_url) {
    const src = json.voice_audio_url.startsWith("http")
      ? json.voice_audio_url
      : API_BASE + json.voice_audio_url;

    const audio = document.createElement("audio");
    audio.controls = true;
    audio.autoplay = true;
    audio.src = src;
    audioArea.appendChild(audio);
  } else {
    audioArea.innerText = "éŸ³å£°ãªã—ï¼ˆVoiceVox ã‚¨ãƒ©ãƒ¼ï¼‰";
  }

  hideLoading();
  document.getElementById("previewArea").style.display = "none";
  document.getElementById("status").innerText = "é€ä¿¡å®Œäº†";
};

// ---------------------------------------------------
// NG â†’ å†éŒ²éŸ³
// ---------------------------------------------------
document.getElementById("previewNG").onclick = async () => {

  audioChunks = [];
  audioBlob = null;

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‰ã˜ã‚‹
  document.getElementById("previewArea").style.display = "none";
  document.getElementById("status").innerText =
    "å†éŒ²éŸ³ã‚’é–‹å§‹ã—ã¾ã™â€¦";

  // è‡ªå‹•éŒ²éŸ³é–‹å§‹
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });

  mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);

  mediaRecorder.onstop = async () => {
    audioBlob = new Blob(audioChunks, { type: "audio/webm" });

    document.getElementById("status").innerText =
      "éŒ²éŸ³å®Œäº† â†’ Whisperã§è§£æä¸­â€¦";

    showLoading(); // å†éŒ²éŸ³ Whisperå‰
    await previewTranscription();
  };

  mediaRecorder.start();
  document.getElementById("status").innerText =
    "éŒ²éŸ³ä¸­â€¦ï¼ˆNGå¾Œã®éŒ²éŸ³ï¼‰";

  document.getElementById("recBtn").innerText = "â–  éŒ²éŸ³åœæ­¢";
};

</script>

</body>
</html>
